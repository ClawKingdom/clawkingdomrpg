<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CLAW KINGDOM - Profile & Inventory</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Press Start 2P', cursive; background: linear-gradient(135deg, #c8c8d8 0%, #a8a8c8 100%); color: #1a1a2e; min-height: 100vh; padding: 24px; line-height: 1.6; }
header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; margin-bottom: 24px; border-bottom: 4px solid #1a1a2e; }
.logo { display: flex; align-items: center; gap: 12px; }
.logo-box { width: 48px; height: 48px; background: #9333ea; border: 2px solid #1a1a2e; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; }
.logo-text { color: #9333ea; font-weight: bold; font-size: 18px; letter-spacing: 2px; }
.back-btn { background: #1a1a2e; color: white; padding: 8px 16px; border: 2px solid black; font-weight: bold; font-size: 12px; cursor: pointer; font-family: 'Press Start 2P', cursive; transition: all 0.3s; }
.back-btn:hover { background: #9333ea; }
h1 { text-align: center; font-size: 32px; font-weight: bold; margin-bottom: 32px; color: #9333ea; letter-spacing: 2px; text-shadow: 3px 3px 0px rgba(0,0,0,0.3); }
.main-grid { display: grid; grid-template-columns: 300px 1fr 380px; gap: 16px; max-width: 1600px; margin: 0 auto; }
.panel { background: rgba(249,250,251,0.8); border: 4px solid #1a1a2e; padding: 20px; }
.panel-title { color: #9333ea; font-weight: bold; text-align: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 4px solid #9333ea; font-size: 14px; }
.avatar { width: 100%; aspect-ratio: 1; background: #1a1a2e; border: 4px solid #9333ea; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; font-size: 120px; }
.char-info { text-align: center; margin-bottom: 16px; }
.char-name { color: #9333ea; font-weight: bold; font-size: 20px; margin-bottom: 8px; }
.char-class { color: #ca8a04; font-weight: bold; margin-bottom: 4px; font-size: 12px; }
.char-level { color: #1f2937; font-weight: bold; font-size: 14px; }
.xp-container { margin-bottom: 16px; }
.xp-label { color: #1f2937; font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; font-size: 12px; }
.xp-bar { width: 100%; height: 24px; background: #1a1a2e; border: 2px solid black; position: relative; }
.xp-fill { height: 100%; background: #9333ea; transition: width 0.3s; }
.xp-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 12px; }
.void-counter { font-size: 16px; color: #a855f7; font-weight: bold; }
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.stat-box { background: #e5e7eb; border: 2px solid #374151; padding: 8px 6px; overflow: hidden; min-height: 52px; }
.stat-label { font-size: 7px; font-weight: bold; color: #4b5563; letter-spacing: 0.5px; margin-bottom: 4px; white-space: nowrap; }
.stat-value { color: #9333ea; font-weight: bold; font-size: 16px; }
.equipment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.equipment-slot { background: #1f2937; border: 4px solid #6b7280; padding: 16px; cursor: pointer; transition: all 0.3s; position: relative; min-height: 100px; }
.equipment-slot:hover { border-color: #9333ea; }
.slot-label { font-size: 12px; font-weight: bold; color: #9ca3af; margin-bottom: 8px; }
.slot-icon { text-align: center; font-size: 40px; margin-bottom: 8px; }
.slot-name { font-size: 12px; text-align: center; font-weight: bold; }
.slot-stats { font-size: 12px; text-align: center; margin-top: 4px; color: #34d399; }
.empty-slot { text-align: center; color: #6b7280; font-style: italic; font-size: 12px; margin-top: 24px; }
.inventory-header { font-size: 12px; font-weight: bold; color: #374151; margin-bottom: 8px; display: flex; justify-content: space-between; }
.inventory-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-height: 400px; overflow-y: auto; padding-right: 8px; }
.inventory-slot { aspect-ratio: 1; background: #1f2937; border: 2px solid; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: grab; transition: all 0.2s; }
.inventory-slot:not(.empty):hover { transform: scale(1.1); }
.inventory-slot.empty { opacity: 0.4; cursor: default; }
.rarity-common { border-color: #9ca3af !important; border-width: 3px !important; }
.rarity-uncommon { border-color: #10b981 !important; border-width: 3px !important; }
.rarity-rare { border-color: #3b82f6 !important; border-width: 3px !important; }
.rarity-epic { border-color: #a855f7 !important; border-width: 3px !important; }
.rarity-legendary { border-color: #fbbf24 !important; border-width: 3px !important; }
.rarity-void { border-color: #c084fc !important; border-width: 3px !important; }
.delete-btn { background: #ef4444; color: white; padding: 16px 40px; border: 4px solid #dc2626; font-family: 'Press Start 2P', cursive; font-size: 12px; cursor: pointer; transition: all 0.3s; letter-spacing: 2px; }
.delete-btn:hover { background: #dc2626; transform: translateY(-2px); }
@media (max-width: 1400px) { .main-grid { grid-template-columns: 1fr; } }
.item-tooltip { position: absolute; background: #1a1a2e; border: 3px solid #a855f7; padding: 12px; border-radius: 4px; z-index: 1000; pointer-events: none; font-size: 11px; min-width: 160px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: none; }
.item-tooltip.active { display: block; }
.tooltip-name { color: #a855f7; font-weight: bold; margin-bottom: 6px; font-size: 12px; }
.tooltip-rarity { color: #fbbf24; font-size: 10px; margin-bottom: 6px; }
.tooltip-type { color: #9ca3af; font-size: 10px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid #374151; }
.tooltip-stat { display: flex; justify-content: space-between; margin-bottom: 3px; color: #d1d5db; font-size: 10px; }
.tooltip-stat-val { color: #34d399; font-weight: bold; }
</style>
</head>
<body>

<header>
<div class="logo"><div class="logo-box">CK</div><div class="logo-text">CLAW KINGDOM</div></div>
<div style="display: flex; gap: 10px;">
<button class="back-btn" onclick="window.location.href='index.html'">‚Üê BACK TO HOME</button>
<button class="back-btn" style="background: #6b21a8; border-color: #a855f7;" onclick="window.location.href='dungeons.html'">‚öî DUNGEONS</button>
</div>
</header>

<h1>PROFILE & INVENTORY</h1>

<div class="main-grid">

<div class="panel">
<div class="panel-title">CHARACTER</div>
<div class="avatar" id="avatar">ü¶û</div>
<input type="file" id="avatar-upload" accept="image/*" style="width:100%;margin-bottom:12px;font-size:8px;padding:8px;border:2px solid #a855f7;background:#f3f4f6;cursor:pointer;">
<div class="char-info">
<div class="char-name" id="charName">HERO</div>
<div class="char-class" id="charClass">WARRIOR</div>
<div class="char-level" id="charLevel">Level 1</div>
</div>
<div class="xp-container">
<div class="xp-label"><span>XP</span><span id="xpValue">0 / 1000</span></div>
<div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div><div class="xp-text" id="xpText">0%</div></div>
</div>
<div class="xp-container" style="margin-top: 16px; border-top: 2px solid #374151; padding-top: 16px;">
<div class="xp-label"><span>üíú VOID</span><span id="voidValue">0</span></div>
</div>
<div class="stats-grid">
<div class="stat-box"><div class="stat-label">STR</div><div class="stat-value" id="statStr">10</div></div>
<div class="stat-box"><div class="stat-label">DEX</div><div class="stat-value" id="statDex">10</div></div>
<div class="stat-box"><div class="stat-label">INT</div><div class="stat-value" id="statInt">10</div></div>
<div class="stat-box"><div class="stat-label">VIT</div><div class="stat-value" id="statVit">10</div></div>
<div class="stat-box"><div class="stat-label">ATK</div><div class="stat-value" id="statAtk">30</div></div>
<div class="stat-box"><div class="stat-label">DEF</div><div class="stat-value" id="statDef">15</div></div>
<div class="stat-box"><div class="stat-label">CRIT%</div><div class="stat-value" id="statCrit">5%</div></div>
<div class="stat-box"><div class="stat-label">CRIT DMG</div><div class="stat-value" id="statCritDmg">150%</div></div>
</div>
</div>

<div class="panel">
<div class="panel-title">EQUIPMENT</div>
<div class="equipment-grid" id="equipmentGrid">
<!-- Equipment slots go here -->
</div>

<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #374151;">
<div style="font-size: 10px; color: #a855f7; font-weight: bold; margin-bottom: 12px; letter-spacing: 1px;">üß™ CONSUMABLES</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
<div class="equipment-slot" id="consumable-1" style="min-height: 80px; cursor: grab;" ondrop="dropConsumable(event, 1)" ondragover="allowDrop(event)">
<div class="slot-label">POTION 1</div>
<div class="slot-icon" id="cons-1-icon">üíä</div>
<div class="empty-slot">Empty</div>
</div>
<div class="equipment-slot" id="consumable-2" style="min-height: 80px; cursor: grab;" ondrop="dropConsumable(event, 2)" ondragover="allowDrop(event)">
<div class="slot-label">POTION 2</div>
<div class="slot-icon" id="cons-2-icon">üíä</div>
<div class="empty-slot">Empty</div>
</div>
<div class="equipment-slot" id="consumable-3" style="min-height: 80px; cursor: grab;" ondrop="dropConsumable(event, 3)" ondragover="allowDrop(event)">
<div class="slot-label">POTION 3</div>
<div class="slot-icon" id="cons-3-icon">üíä</div>
<div class="empty-slot">Empty</div>
</div>
</div>
</div>
</div>

<div class="panel">
<div class="panel-title">INVENTORY</div>
<div class="inventory-header"><span>BACKPACK</span><span id="inventoryCount">0 / 50</span></div>
<div class="inventory-grid" id="inventoryGrid">
<!-- Inventory slots go here -->
</div>
<div style="text-align: center; margin-top: 24px; padding-top: 16px; border-top: 2px solid #374151;">
<button style="background: #6b21a8; color: white; padding: 12px 32px; border: 4px solid #a855f7; font-family: 'Press Start 2P', cursive; font-size: 10px; cursor: pointer; transition: all 0.3s; letter-spacing: 2px;" onclick="window.location.href='dungeons.html'">‚öî GO DUNGEONS</button>
</div>
</div>

</div>

<div style="text-align: center; margin-top: 40px; padding: 30px; border-top: 4px solid #1a1a2e;">
<button class="delete-btn" onclick="window.deleteCharacter()">üóë DELETE CHARACTER</button>
</div>

<script>
const ITEM_DATABASE = {
  'iron_sword': { id: 'iron_sword', name: 'Iron Sword', icon: '‚öîÔ∏è', rarity: 'common', slot: 'weapon', stats: { str: 5, dex: 2, attack: 15 }, description: 'A standard iron blade.' },
  'wooden_shield': { id: 'wooden_shield', name: 'Wooden Shield', icon: 'üõ°Ô∏è', rarity: 'common', slot: 'offhand', stats: { vit: 4, defense: 20 }, description: 'Basic protection.' },
  'leather_armor': { id: 'leather_armor', name: 'Leather Armor', icon: 'üß•', rarity: 'uncommon', slot: 'chest', stats: { vit: 3, dex: 1, defense: 25 }, description: 'Light armor.' },
  'steel_helmet': { id: 'steel_helmet', name: 'Steel Helmet', icon: '‚õëÔ∏è', rarity: 'common', slot: 'helmet', stats: { vit: 3, defense: 15 }, description: 'Head protection.' }
};

const SLOT_LABELS = {
  weapon: '‚öî WEAPON', helmet: '‚õë HELMET', chest: 'üõ° CHEST', gloves: 'üß§ GLOVES', boots: 'üë¢ BOOTS',
  offhand: 'üõ° OFF-HAND', ring: 'üíç RING 1', ring2: 'üíç RING 2', amulet: 'üìø AMULET'
};

// Map item types from dungeons to equipment slots
const TYPE_TO_SLOT = {
  'weapon': 'weapon',
  'helmet': 'helmet',
  'chest': 'chest',
  'boots': 'boots',
  'gloves': 'gloves',
  'offhand': 'offhand',
  'ring': 'ring',
  'amulet': 'amulet',
  'accessory': 'ring'
};

const RARITY_COLORS = {
  common: '#9ca3af', 
  uncommon: '#10b981', 
  rare: '#3b82f6', 
  epic: '#a855f7', 
  legendary: '#fbbf24',
  void: '#c084fc'
};

let character = JSON.parse(localStorage.getItem('clawkingdom_character') || 'null');
let inventory = JSON.parse(localStorage.getItem('clawkingdom_inventory') || '[]');
let voidTotal = parseInt(localStorage.getItem('clawkingdom_void_total') || '0');
let equipment = character?.equipment || { weapon: 'iron_sword', helmet: 'steel_helmet', chest: 'leather_armor', offhand: 'wooden_shield', gloves: null, boots: null, ring: null, ring2: null, amulet: null };
let draggedItemIndex = null;

function render() {
  if (!character) { alert('No character found!'); window.location.href = 'character-creation.html'; return; }
  
  // Update character panel
  const CLASS_ICONS = { warrior: '‚öîÔ∏è', mage: 'üîÆ', rogue: 'üó°Ô∏è', paladin: '‚ö°', ranger: 'üèπ', bard: 'üéµ' };
  document.getElementById('charName').textContent = character.name.toUpperCase();
  document.getElementById('charClass').textContent = (CLASS_ICONS[character.class] || '‚öîÔ∏è') + ' ' + character.class.toUpperCase();
  document.getElementById('charLevel').textContent = 'Level ' + (character.level || 1);
  document.getElementById('avatar').textContent = CLASS_ICONS[character.class] || '‚öîÔ∏è';
  
  const xpNeeded = 1000 * (character.level || 1);
  const xpPct = Math.min(100, Math.round((character.xp || 0) / xpNeeded * 100));
  document.getElementById('xpValue').textContent = (character.xp || 0) + ' / ' + xpNeeded;
  document.getElementById('xpFill').style.width = xpPct + '%';
  document.getElementById('xpText').textContent = xpPct + '%';
  
  // Display VOID total
  document.getElementById('voidValue').textContent = voidTotal.toLocaleString();
  
  // Render equipment grid (clickable to unequip)
  const eqGrid = document.getElementById('equipmentGrid');
  eqGrid.innerHTML = '';
  Object.keys(SLOT_LABELS).forEach(slot => {
    const div = document.createElement('div');
    div.className = 'equipment-slot';
    div.dataset.slot = slot;
    const equipmentItem = equipment[slot];
    
    // Get item object (handle both legacy ID format and modern object format)
    let item = null;
    if (equipmentItem) {
      if (typeof equipmentItem === 'string' && ITEM_DATABASE[equipmentItem]) {
        item = ITEM_DATABASE[equipmentItem];
      } else if (typeof equipmentItem === 'object') {
        item = equipmentItem;
      }
    }
    
    if (item) { div.style.borderColor = RARITY_COLORS[item.rarity]; }
    
    const itemRarity = item?.rarity || 'common';
    const rarityColor = RARITY_COLORS[itemRarity] || '#9ca3af';
    
    let statsDisplay = '';
    if (item) {
      const statNames = ['str','dex','int','vit','atk','def','crit','critdmg'];
      // Collect stats from both formats
      const itemStats = {};
      statNames.forEach(s => {
        if (item[s] !== undefined && item[s] !== null) {
          itemStats[s] = item[s];
        } else if (item.stats && item.stats[s] !== undefined && item.stats[s] !== null) {
          itemStats[s] = item.stats[s];
        }
      });
      
      const statKeys = Object.keys(itemStats).filter(s => itemStats[s] !== 0);
      if (statKeys.length > 0) {
        const topStats = statKeys.slice(0, 2).map(s => `<span style="color:#34d399">${s.toUpperCase()}${itemStats[s]>0?'+':''}${itemStats[s]}</span>`).join(' / ');
        statsDisplay = '<div class="slot-stats">' + topStats + '</div>';
      }
    }
    
    div.innerHTML = '<div class="slot-label">' + SLOT_LABELS[slot] + '</div>' +
      (item ? '<div class="slot-icon">' + item.icon + '</div><div class="slot-name" style="color: ' + rarityColor + '">' + item.name + '</div>' + statsDisplay : '<div class="empty-slot">Empty</div>');
    
    // Tooltip on hover (show tooltip for equipped item)
    if (item) {
      div.addEventListener('mouseenter', (e) => { 
        showItemTooltip(e, item); 
      });
      div.addEventListener('mouseleave', () => { hideItemTooltip(); });
    }
    
    // Unequip on click
    div.addEventListener('click', () => {
      if (equipment[slot]) {
        // Push the full item object, not just the ID
        const unequippedItem = equipment[slot];
        if (typeof unequippedItem === 'string') {
          // Legacy: item is just an ID, look it up
          const itemData = ITEM_DATABASE[unequippedItem];
          if (itemData) inventory.push({...itemData});
        } else {
          // Modern: item is already an object, push it
          inventory.push(unequippedItem);
        }
        equipment[slot] = null;
        saveData();
        render();
      }
    });
    
    // Accept drops
    div.addEventListener('dragover', (e) => { e.preventDefault(); div.style.opacity = '0.7'; });
    div.addEventListener('dragleave', () => { div.style.opacity = '1'; });
    div.addEventListener('drop', (e) => {
      e.preventDefault();
      div.style.opacity = '1';
      if (draggedItemIndex !== null && draggedItemIndex < inventory.length) {
        const draggedItem = inventory[draggedItemIndex];
        
        // Get the slot type from the item
        let itemSlot = null;
        if (typeof draggedItem === 'string' && ITEM_DATABASE[draggedItem]) {
          // Legacy: item ID lookup
          itemSlot = ITEM_DATABASE[draggedItem].slot;
        } else if (typeof draggedItem === 'object') {
          // Modern: item object (from dungeon drops or unequip)
          // Try slot first, then type, then map type to slot
          itemSlot = draggedItem.slot || TYPE_TO_SLOT[draggedItem.type] || draggedItem.type;
        }
        
        // Check if slot matches
        if (itemSlot === slot) {
          if (equipment[slot]) {
            // Store the unequipped item
            const unequipped = equipment[slot];
            inventory.push(typeof unequipped === 'string' ? ITEM_DATABASE[unequipped] || unequipped : unequipped);
          }
          equipment[slot] = draggedItem;
          inventory.splice(draggedItemIndex, 1);
          draggedItemIndex = null;
          saveData();
          render();
        }
      }
    });
    eqGrid.appendChild(div);
  });
  
  // Render inventory grid (draggable)
  const invGrid = document.getElementById('inventoryGrid');
  invGrid.innerHTML = '';
  const items = inventory || [];
  items.forEach((item, index) => {
    const div = document.createElement('div');
    const rarityClass = 'rarity-' + (item.rarity || 'common');
    div.className = 'inventory-slot ' + rarityClass;
    div.draggable = true;
    div.style.position = 'relative';
    div.style.borderColor = RARITY_COLORS[item.rarity || 'common'];
    
    // Force icon display
    div.textContent = '';
    const iconEl = document.createElement('span');
    iconEl.textContent = item.icon || 'üì¶';
    iconEl.style.fontSize = '28px';
    iconEl.style.lineHeight = '1';
    div.appendChild(iconEl);
    
    div.addEventListener('dragstart', () => { draggedItemIndex = index; div.style.opacity = '0.5'; });
    div.addEventListener('dragend', () => { div.style.opacity = '1'; });
    
    // Tooltip on hover
    div.addEventListener('mouseenter', (e) => { showItemTooltip(e, item); });
    div.addEventListener('mouseleave', () => { hideItemTooltip(); });
    
    invGrid.appendChild(div);
  });
  
  for (let i = items.length; i < 50; i++) {
    const div = document.createElement('div');
    div.className = 'inventory-slot empty';
    invGrid.appendChild(div);
  }
  document.getElementById('inventoryCount').textContent = items.length + ' / 50';
  
  renderConsumables();
  updateStats();
}

function saveData() {
  localStorage.setItem('clawkingdom_character', JSON.stringify(character));
  localStorage.setItem('clawkingdom_inventory', JSON.stringify(inventory));
  localStorage.setItem('clawkingdom_void_total', voidTotal.toString());
}

function addVoid(amount) {
  voidTotal += amount;
  localStorage.setItem('clawkingdom_void_total', voidTotal.toString());
  if (document.getElementById('voidValue')) {
    document.getElementById('voidValue').textContent = voidTotal.toLocaleString();
  }
}

function updateStats() {
  if (!character) return;
  const stats = { str: 10, dex: 10, int: 10, vit: 10 };
  
  Object.values(equipment).forEach(item => {
    if (!item) return;
    
    // Handle legacy format: item is just an ID string
    if (typeof item === 'string' && ITEM_DATABASE[item]) {
      const dbItem = ITEM_DATABASE[item];
      if (dbItem.stats) {
        Object.keys(dbItem.stats).forEach(stat => {
          stats[stat] = (stats[stat] || 0) + dbItem.stats[stat];
        });
      }
    }
    // Handle modern format: item is an object with direct stat properties
    else if (typeof item === 'object') {
      ['str','dex','int','vit','atk','def','crit','critdmg'].forEach(stat => {
        if (item[stat] !== undefined && item[stat] !== null) {
          stats[stat] = (stats[stat] || 0) + item[stat];
        }
      });
      // Also check nested stats object
      if (item.stats) {
        Object.keys(item.stats).forEach(stat => {
          stats[stat] = (stats[stat] || 0) + item.stats[stat];
        });
      }
    }
  });
  
  const lvl = character.level || 1;
  stats.attack = (stats.str || 10) * 2 + lvl;
  stats.defense = Math.floor((stats.vit || 10) * 1.5) + lvl;
  stats.crit = Math.min(50, Math.floor((stats.dex || 10) * 0.5));
  stats.critDmg = 150 + (stats.dex || 10);
  
  document.getElementById('statStr').textContent = stats.str;
  document.getElementById('statDex').textContent = stats.dex;
  document.getElementById('statInt').textContent = stats.int;
  document.getElementById('statVit').textContent = stats.vit;
  document.getElementById('statAtk').textContent = stats.attack;
  document.getElementById('statDef').textContent = stats.defense;
  document.getElementById('statCrit').textContent = stats.crit + '%';
  document.getElementById('statCritDmg').textContent = stats.critDmg + '%';
}

let currentTooltip = null;

function showItemTooltip(event, item) {
  if (!item) return;
  const rarity = item.rarity || 'common';
  const statNames = ['str','dex','int','vit','atk','def','crit','critdmg'];
  
  // Collect stats from both formats: item.stat and item.stats.stat
  const statValues = {};
  statNames.forEach(s => {
    // Check direct property (dungeon drops)
    if (item[s] !== undefined && item[s] !== null) {
      statValues[s] = item[s];
    }
    // Check nested stats object (ITEM_DATABASE)
    else if (item.stats && item.stats[s] !== undefined && item.stats[s] !== null) {
      statValues[s] = item.stats[s];
    }
  });
  
  const stats = Object.keys(statValues).filter(s => statValues[s] !== 0);
  
  let tooltip = document.getElementById('item-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'item-tooltip';
    tooltip.className = 'item-tooltip';
    document.body.appendChild(tooltip);
  }
  
  let statRows = stats.length > 0 
    ? stats.map(s => {
        const val = statValues[s];
        const sign = val > 0 ? '+' : '';
        return `<div class="tooltip-stat"><span>${s.toUpperCase()}</span><span class="tooltip-stat-val">${sign}${val}</span></div>`;
      }).join('')
    : '<div style="color:#9ca3af;font-size:10px">No stat bonuses</div>';
  
  const tooltipColor = RARITY_COLORS[rarity] || '#9ca3af';
  const itemType = item.type || (item.slot ? item.slot.toUpperCase() : 'ITEM');
  
  tooltip.innerHTML = `
    <div class="tooltip-name" style="color:${tooltipColor}">${item.name}</div>
    <div class="tooltip-rarity" style="color:${tooltipColor}">‚óÜ ${rarity.toUpperCase()}</div>
    <div class="tooltip-type">${itemType}</div>
    <div>${statRows}</div>
  `;
  tooltip.classList.add('active');
  
  const rect = event.target.getBoundingClientRect();
  tooltip.style.position = 'fixed';
  tooltip.style.left = (rect.right + 8) + 'px';
  tooltip.style.top = (rect.top - 12) + 'px';
  tooltip.style.maxWidth = '180px';
  tooltip.style.borderColor = tooltipColor;
  currentTooltip = tooltip;
}

function hideItemTooltip() {
  if (currentTooltip) {
    currentTooltip.classList.remove('active');
  }
}

window.deleteCharacter = function() {
  if (confirm('‚ö†Ô∏è DELETE CHARACTER PERMANENTLY? This cannot be undone!')) {
    const wallet = localStorage.getItem('clawkingdom_wallet');
    
    // Remove all character data
    localStorage.removeItem('clawkingdom_character');
    localStorage.removeItem('clawkingdom_equipment');
    localStorage.removeItem('clawkingdom_inventory');
    localStorage.removeItem('clawkingdom_stamina');
    localStorage.removeItem('clawkingdom_raid_history');
    localStorage.removeItem('clawkingdom_void_total');
    
    // Remove avatar
    if (wallet) {
      localStorage.removeItem(`avatar_${wallet}`);
    }
    
    // Remove from leaderboard
    const allAgents = JSON.parse(localStorage.getItem('clawkingdom_all_agents') || '[]');
    const filtered = allAgents.filter(a => a.wallet !== wallet);
    localStorage.setItem('clawkingdom_all_agents', JSON.stringify(filtered));
    
    alert('‚úÖ Character permanently deleted!');
    window.location.href = 'character-creation.html';
  }
};

// Avatar upload handler
const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
const MAX_DIMENSIONS = 512;

function handleAvatarUpload(file) {
  if (!file) return;
  if (file.size > MAX_FILE_SIZE) {
    alert('‚ùå Image too large (max 2MB)');
    return;
  }
  if (!ALLOWED_TYPES.includes(file.type)) {
    alert('‚ùå Only PNG/JPEG/WebP allowed');
    return;
  }
  
  const img = new Image();
  img.onload = () => {
    if (img.width > MAX_DIMENSIONS || img.height > MAX_DIMENSIONS) {
      alert(`‚ùå Max ${MAX_DIMENSIONS}x${MAX_DIMENSIONS} pixels`);
      return;
    }
    
    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    
    const base64 = canvas.toDataURL('image/png');
    localStorage.setItem('clawkingdom_character_avatar', base64);
    updateAvatarDisplay(base64);
    alert('‚úÖ Avatar uploaded!');
  };
  
  img.onerror = () => alert('‚ùå Invalid image file');
  img.src = URL.createObjectURL(file);
}

function updateAvatarDisplay(base64) {
  const avatar = document.getElementById('avatar');
  avatar.style.backgroundImage = `url('${base64}')`;
  avatar.style.backgroundSize = 'cover';
  avatar.style.backgroundPosition = 'center';
  avatar.textContent = '';
}

function restoreAvatarFromStorage() {
  const saved = localStorage.getItem('clawkingdom_character_avatar');
  if (saved) updateAvatarDisplay(saved);
}

// ===== CONSUMABLES SYSTEM =====
let draggedItemIndex = -1;

function allowDrop(ev) { ev.preventDefault(); }

function dropConsumable(ev, slotNum) {
  ev.preventDefault();
  if (draggedItemIndex < 0) return;
  
  const inventory = character.inventory || [];
  const item = inventory[draggedItemIndex];
  if (!item) return;
  
  if (!item.name.toLowerCase().includes('potion')) {
    alert('‚ö†Ô∏è Only potions can be equipped here!');
    draggedItemIndex = -1;
    return;
  }
  
  if (!character.consumables) character.consumables = {};
  character.consumables[`slot${slotNum}`] = item;
  inventory.splice(draggedItemIndex, 1);
  
  draggedItemIndex = -1;
  saveCharacter();
  render();
  alert(`‚úÖ ${item.name} equipped!`);
}

function unequipConsumable(slotNum) {
  if (!character.consumables || !character.consumables[`slot${slotNum}`]) return;
  const item = character.consumables[`slot${slotNum}`];
  character.inventory.push(item);
  delete character.consumables[`slot${slotNum}`];
  saveCharacter();
  render();
}

function renderConsumables() {
  for (let i = 1; i <= 3; i++) {
    const slot = document.getElementById(`consumable-${i}`);
    const consumable = character.consumables?.[`slot${i}`];
    
    if (consumable) {
      slot.innerHTML = `
        <div class="slot-label">POTION ${i}</div>
        <div class="slot-icon" style="cursor:pointer;opacity:0.8" onclick="unequipConsumable(${i})">${consumable.icon}</div>
        <div class="slot-name">${consumable.name}</div>
        <div style="font-size:8px;color:#aaa;margin-top:4px;cursor:pointer" onclick="unequipConsumable(${i})">Click to unequip</div>
      `;
      slot.style.borderColor = '#a855f7';
    } else {
      slot.innerHTML = `
        <div class="slot-label">POTION ${i}</div>
        <div class="slot-icon">üíä</div>
        <div class="empty-slot">Drag potion here</div>
      `;
      slot.style.borderColor = '#6b7280';
    }
  }
}

// Initialize on load
window.addEventListener('DOMContentLoaded', () => {
  render();
  restoreAvatarFromStorage();
  
  const uploadInput = document.getElementById('avatar-upload');
  if (uploadInput) {
    uploadInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleAvatarUpload(e.target.files[0]);
        e.target.value = ''; // Reset input
      }
    });
  }
});
</script>

</body>
</html>
